rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function userData() {
      return isSignedIn()
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
          : null;
    }

    function role() {
      return isSignedIn() ? userData().role : null;
    }

    function departmentId() {
      return isSignedIn() ? userData().department_id : null;
    }

    function isAdmin() {
      return isSignedIn() && role() == 'admin';
    }

    function isManager() {
      return isSignedIn() && role() == 'manager';
    }

    function isEmployee() {
      return isSignedIn() && role() == 'employee';
    }

    function sameDept(deptId) {
      return departmentId() != null && departmentId() == deptId;
    }

    function creatorId() {
      return isSignedIn() ? userData().created_by_user_id : null;
    }

    function isAdminOrManagerForDept(deptId) {
      return isAdmin() || (isManager() && sameDept(deptId));
    }

    function requestDept(requestId) {
      return get(/databases/$(database)/documents/requests/$(requestId)).data.department_id;
    }

    function bootstrapUserDoc() {
      return getAfter(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isBootstrapAdmin() {
      return isSignedIn()
          && existsAfter(/databases/$(database)/documents/users/$(request.auth.uid))
          && bootstrapUserDoc().data.role == 'admin';
    }

    function isBootstrapUserCreate(uid) {
      return isSignedIn()
          && request.auth.uid == uid
          && !exists(/databases/$(database)/documents/users/$(uid))
          && request.resource.data.role == 'admin'
          && request.resource.data.department_id is string
          && existsAfter(/databases/$(database)/documents/departments/$(request.resource.data.department_id))
          && request.resource.data.created_at is timestamp
          && request.resource.data.updated_at is timestamp;
    }

    match /users/{uid} {
      allow read: if (isSignedIn() && request.auth.uid == uid)
          || (isAdmin() && resource.data.created_by_user_id == request.auth.uid)
          || (isManager()
              && (
                resource.data.manager_id == request.auth.uid
                || (resource.data.role == 'admin' && resource.id == creatorId())
              )
            )
          || (isEmployee() && sameDept(resource.data.department_id));
      allow create: if isBootstrapUserCreate(uid);
      allow update, delete: if isAdmin();
    }

    match /requests/{requestId} {
      allow read: if isAdmin()
          || (isManager() && sameDept(resource.data.department_id))
          || (isSignedIn() && resource.data.created_by_user_id == request.auth.uid);

      allow create: if isSignedIn()
          && request.resource.data.created_by_user_id == request.auth.uid
          && request.resource.data.department_id == departmentId()
          && request.resource.data.status == 'pending'
          && request.resource.data.type in ['leave', 'advance', 'expense']
          && request.resource.data.created_at is timestamp
          && request.resource.data.updated_at is timestamp;

      allow update: if (
          isAdminOrManagerForDept(resource.data.department_id)
          || (isSignedIn()
              && resource.data.created_by_user_id == request.auth.uid
              && request.resource.data.status == 'cancelled')
        )
        && request.resource.data.created_by_user_id == resource.data.created_by_user_id
        && request.resource.data.department_id == resource.data.department_id
        && request.resource.data.type == resource.data.type
        && request.resource.data.reason == resource.data.reason
        && request.resource.data.amount == resource.data.amount
        && request.resource.data.currency == resource.data.currency
        && request.resource.data.start_date == resource.data.start_date
        && request.resource.data.end_date == resource.data.end_date
        && request.resource.data.category == resource.data.category
        && request.resource.data.created_at == resource.data.created_at
        && request.resource.data.status in ['pending', 'approved', 'rejected', 'cancelled']
        && request.resource.data.updated_at is timestamp;

      allow delete: if false;
    }

    match /request_approvals/{approvalId} {
      allow read: if isAdmin()
          || (isManager() && sameDept(requestDept(resource.data.request_id)));
      allow create: if isAdminOrManagerForDept(requestDept(request.resource.data.request_id))
          && request.resource.data.action in ['approved', 'rejected']
          && request.resource.data.reviewed_at is timestamp;
      allow update, delete: if false;
    }

    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdminOrManagerForDept(request.resource.data.department_id)
          || (isSignedIn()
              && request.resource.data.actor_user_id == request.auth.uid
              && request.resource.data.entity_type == 'bootstrap'
              && request.resource.data.action == 'create_admin');
      allow update, delete: if false;
    }

    match /departments/{deptId} {
      allow read: if isAdmin() || isManager();
      allow create: if isAdmin()
          || (isBootstrapAdmin() && request.resource.data.manager_id == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    match /tasks/{taskId} {
      allow read: if isAdmin()
          || (isManager() && sameDept(resource.data.department_id))
          || (isSignedIn() && resource.data.assigned_to_user_id == request.auth.uid);
      allow create, update, delete: if isAdminOrManagerForDept(request.resource.data.department_id);
    }

    match /shifts/{shiftId} {
      allow read: if isAdmin()
          || (isManager() && sameDept(resource.data.department_id))
          || (isSignedIn() && resource.data.user_id == request.auth.uid);
      allow create, update, delete: if isAdminOrManagerForDept(request.resource.data.department_id);
    }
  }
}
